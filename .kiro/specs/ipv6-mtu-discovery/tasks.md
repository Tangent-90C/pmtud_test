# 实现计划

- [x] 1. 设置项目结构和核心接口
  - 创建Go模块和目录结构
  - 定义核心数据结构和接口
  - 设置依赖管理和构建配置
  - _需求: 1.1, 1.4_

- [x] 2. 实现命令行接口和参数解析
  - [x] 2.1 创建CLI参数结构和解析逻辑
    - 使用cobra库实现命令行接口
    - 定义CLIArgs结构体和ProbeMode枚举
    - 实现参数验证和默认值设置
    - _需求: 1.1, 1.3_

  - [x] 2.2 实现使用说明和帮助信息
    - 创建详细的使用说明文档
    - 实现命令行帮助显示功能
    - 添加示例用法和参数说明
    - _需求: 1.3_

- [x] 3. 实现IPv6地址验证和权限检查
  - [x] 3.1 创建IPv6地址验证器
    - 实现IPv6Address结构体和验证函数
    - 添加地址格式检查和可达性测试
    - 处理各种IPv6地址格式（完整、压缩、混合等）
    - _需求: 1.1, 1.2_

  - [x] 3.2 实现跨平台权限检查
    - 创建PermissionChecker结构体
    - 实现Linux/macOS/Windows的权限检查
    - 添加权限错误处理和提示信息
    - _需求: 1.4, 1.5_

- [x] 4. 实现ICMP6数据包处理
  - [x] 4.1 创建ICMP6包构造器
    - 实现ICMP6Packet结构体和构造函数
    - 添加不同载荷大小的包生成功能
    - 实现包的序列化和校验和计算
    - _需求: 2.1, 2.3_

  - [x] 4.2 实现PMTUD响应解析器
    - 创建PMTUDResponse结构体和解析函数
    - 解析ICMPv6"数据包过大"消息
    - 提取中间路由器MTU信息
    - _需求: 2.6, 2.7_

- [x] 5. 实现MTU探测核心逻辑
  - [x] 5.1 创建ICMP6探测器
    - 实现ICMP6Prober结构体和初始化
    - 创建原始套接字连接管理
    - 添加探测包发送和接收逻辑
    - _需求: 2.1, 2.3_

  - [x] 5.2 实现二分搜索算法
    - 创建BinarySearch结构体和算法逻辑
    - 实现MTU范围的高效搜索
    - 添加搜索收敛和结果判断
    - _需求: 2.2, 2.4, 2.5_

  - [x] 5.3 集成MTU探测流程
    - 组合探测器和搜索算法
    - 实现完整的MTU发现过程
    - 添加超时和重试机制
    - _需求: 2.2, 4.1, 4.2, 4.3_

- [x] 6. 实现TCP MSS检测功能
  - [x] 6.1 创建TCP连接管理器
    - 实现TCPManager结构体和连接功能
    - 添加IPv6 TCP套接字创建和管理
    - 实现MSS选项的设置和获取
    - _需求: 5.1, 5.2, 5.3_

  - [x] 6.2 实现MSS检测器
    - 创建MSSDetector结构体
    - 实现客户端和服务端模式的统一接口
    - 添加MSS钳制检测逻辑
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

  - [x] 6.3 扩展TCP连接管理器支持MSS完整性验证
    - 添加控制连接建立和管理功能
    - 实现MSS验证数据的发送和接收
    - 添加连接信息获取和MSS捕获功能
    - _需求: 6.1, 6.2, 6.6, 6.7_

  - [x] 6.4 扩展MSS检测器支持篡改检测
    - 更新MSSDetector结构体支持控制端口和验证功能
    - 实现MSS完整性验证逻辑
    - 添加客户端与服务端MSS值比较功能
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 7. 实现结果显示和错误处理
  - [x] 7.1 创建结果显示器
    - 实现ResultDisplay结构体和格式化功能
    - 添加MTU和MSS结果的详细显示
    - 实现进度显示和PMTUD信息展示
    - _需求: 3.1, 3.2, 3.3, 2.7_

  - [x] 7.3 扩展结果显示器支持MSS完整性验证结果
    - 添加MSS篡改检测结果的显示功能
    - 实现MSS验证过程的进度显示
    - 添加详细的MSS比较和差异报告
    - _需求: 6.4, 6.5_

  - [x] 7.2 实现错误处理系统
    - 创建ProbeError结构体和错误类型
    - 实现统一的错误处理和重试机制
    - 添加用户友好的错误消息
    - _需求: 1.3, 1.5, 4.1, 4.2, 4.5_

- [x] 8. 实现配置管理和跨平台支持
  - [x] 8.1 创建配置管理系统
    - 实现Config和AppConfig结构体
    - 添加YAML/JSON配置文件支持
    - 实现配置验证和默认值处理
    - _需求: 3.5_

  - [x] 8.3 扩展配置管理支持MSS验证功能
    - 添加MSS验证相关的配置选项
    - 实现控制端口和测试MSS的配置管理
    - 添加会话超时和并发限制的配置支持
    - _需求: 6.7_

  - [x] 8.2 添加跨平台支持
    - 实现平台特定的原始套接字创建
    - 添加Windows/Linux/macOS的兼容性代码
    - 处理平台差异和权限要求
    - _需求: 1.4, 1.5_

- [x] 9. 集成主应用程序逻辑
  - [x] 9.1 创建应用程序状态管理
    - 实现AppState结构体和生命周期管理
    - 添加context.Context支持用于取消和超时
    - 集成所有组件到主应用流程
    - _需求: 3.5_

  - [x] 9.2 实现主程序入口和模式选择
    - 创建main函数和应用程序启动逻辑
    - 实现MTU探测、TCP客户端、TCP服务端模式切换
    - 添加优雅的程序退出和资源清理
    - _需求: 1.1, 5.1, 5.2_

  - [x] 9.3 扩展主程序支持MSS完整性验证模式
    - 添加MSS完整性验证模式到模式选择器
    - 实现MSS验证模式的启动和执行逻辑
    - 集成控制连接管理到主应用流程
    - _需求: 6.1, 6.6, 6.7_

- [x] 10. 添加监控和统计功能
  - [x] 10.1 实现网络统计收集
    - 创建NetworkStats和ProbeSession结构体
    - 添加RTT测量和统计计算
    - 实现探测成功率和错误统计
    - _需求: 3.3, 4.3_

  - [x] 10.2 集成统计功能到主应用流程
    - 在MTU探测过程中收集统计数据
    - 在结果显示中包含统计信息
    - 添加详细的性能指标显示
    - _需求: 3.3, 4.3_

- [x] 11. 完善跨平台套接字实现
  - [x] 11.1 实现平台特定的套接字操作
    - 完善Windows/Linux/macOS的原始套接字实现
    - 添加平台特定的错误处理
    - 实现套接字选项的跨平台设置
    - _需求: 1.4, 1.5_

  - [x] 11.2 优化网络性能和可靠性
    - 改进超时和重试机制
    - 添加网络错误的智能处理
    - 优化数据包发送和接收性能
    - _需求: 4.1, 4.2, 4.3_

- [x] 12. 实现MSS完整性验证功能
  - [x] 12.1 创建MSS完整性验证器
    - 实现MSSIntegrityVerifier结构体和验证会话管理
    - 添加客户端和服务端测试执行逻辑
    - 实现MSS值比较和篡改检测算法
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

  - [x] 12.2 实现控制连接管理器
    - 创建ControlConnectionManager结构体
    - 实现控制消息的发送和接收协议
    - 添加会话管理和连接生命周期控制
    - _需求: 6.6, 6.7_

  - [x] 12.3 集成MSS完整性验证到主应用流程
    - 更新命令行参数解析支持MSS验证模式
    - 集成MSS完整性验证器到应用程序状态管理
    - 实现MSS验证结果的显示和报告
    - _需求: 6.1, 6.4, 6.5_

- [x] 13. 添加详细日志记录
  - 实现结构化日志记录
  - 添加调试信息和详细输出选项
  - 创建日志级别控制和文件输出
  - _需求: 3.1_

- [x] 13. 编写单元测试
  - 为IPv6地址验证器编写测试用例
  - 为二分搜索算法编写测试用例
  - 为ICMP6包构造器编写测试用例
  - 为错误处理系统编写测试用例
  - _需求: 1.2, 2.2, 2.1_

- [x] 14. 编写集成测试
  - 创建MTU探测流程的集成测试
  - 编写MSS检测功能的集成测试
  - 添加网络错误场景的测试用例
  - _需求: 2.2, 5.4, 4.1_

- [x] 15. 简化IPv6不可达检测实现
  - [x] 15.1 清理复杂的不可达检测代码
    - 移除UnreachabilityDetector和相关复杂逻辑
    - 移除ReachabilityValidator和缓存机制
    - 移除ResponsePatternAnalyzer和模式分析
    - 清理unreachability_*.go相关文件
    - _需求: 4.1, 4.5_

  - [x] 15.2 实现简化的不可达检测器
    - 创建简单的UnreachabilityChecker结构体
    - 实现基于Echo Request/Reply的检测逻辑
    - 在MTU探测开始前进行连通性检查
    - 如果没有Echo Reply则立即报告不可达
    - _需求: 4.1, 4.2, 4.3_

  - [x] 15.3 集成简化检测到MTU探测流程
    - 更新ICMP6Prober集成简化的不可达检测
    - 修改MTUResult结构体包含不可达状态
    - 更新结果显示器支持不可达报告
    - 确保检测到不可达时立即停止探测
    - _需求: 4.1, 4.4_